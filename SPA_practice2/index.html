<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="app">

    </div>

    <script>
        const $app = document.getElementById("app");
        const template = `
        <header id="header">
            <a href="#/">Home</a>
            <a href="#/counter">counter</a>
            <a href="#/list">list</a>
            </header>
            <main id="main"><h1>Home 페이지</h1></main>
            `
        $app.innerHTML = template;

        
        class Home {
            template(){
                return`
                <h1>Home 페이지</h1>
                `
            }
            render(target){
                target.innerHTML = this.template();
            }
        }
        
        class Counter {
            constructor(target){
                this.target = target;
                this.setup();
                this.render(target);
            }

            setup(){
                this.state = { count : 0 }; 
            }
            plus(prev){
                this.setState({ count : prev + 1 });
            }
            minus(prev){
                this.setState({ count : prev - 1 });
            }
            setEvent(){
                const $btnPlus = document.querySelector(".btn_plus");
                const $btnMinus = document.querySelector(".btn_minus");
                $btnPlus.addEventListener("click", () => {
                    const prev = this.state.count;
                    this.plus(prev)
                });
                $btnMinus.addEventListener("click", () => {
                    const prev = this.state.count;
                    this.minus(prev)
                });
            }
            setState(newState){
                this.state = { ...this.state, ...newState };
                this.render(this.target);
            }
            template(){
                const { count } = this.state;
                return `
                <h1>Counter 페이지</h1>
                <p class="count1">${count}</p>
                <button class="btn_plus">+</button>
                <button class="btn_minus">-</button>
                `
            }
            render(target){
                target.innerHTML = this.template();
                this.setEvent();
            }
        }
        
        class List {
            constructor(target){
                this.target = target;
                this.setup();
                this.render(target);
            }

            template(){
                const { items } = this.state;
                return `
                    <h1>List 페이지</h1>
                    <ul>
                        ${items.map((item, key) => `<li>${item}<button data-index = "${key}" class = "btn_delete">삭제</button></li>`).join('')}
                    </ul>
                    <input type="text" class="input_app">
                    <button class="btn_append">추가</button>
                `;
            }
            setEvent(){
                const $btnAppend = document.querySelector(".btn_append");
                $btnAppend.addEventListener("click", () => {
                    const { items } = this.state;
                    const $inputApp = document.querySelector(".input_app").value;
                    this.setState({ items : [...items, $inputApp]});
                });

                const $btnDelete = document.querySelectorAll(".btn_delete");
                $btnDelete.forEach(btndelete => {
                    btndelete.addEventListener("click", ()=> {
                        const items = [...this.state.items];
                        items.splice(btndelete.dataset.index,1);
                        this.setState({ items })
                    });
                });
            }
            setup(){
                this.state = { items : ["item1"]};
            }

            setState(newState){
                this.state = { ...this.state, ...newState};
                this.render(this.target);
            }

            render(target){
                target.innerHTML = this.template();
                this.setEvent();
            }
        }
        
        class Router {
            // 생성자에서 state()를 호출하면 클래스가 생성될 때 routes 초기화
            // target을 생성자에서 저장하고 클래스의 파라미터로 보내주면 파라미터를 받은 클래스에서 target을 전달하여 유지 가능
            constructor(){
                this.target = document.getElementById("main");

                this.home = new Home(this.target);
                this.counter = new Counter(this.target);
                this.list = new List(this.target);

                this.state();
                this.setState();
            }
            state(){
                // this가 클래스를 넘어오면서 값이 바뀌기 때문에 bind를 해줌
                // 하지만 화살표 함수를 사용하면 자동으로 this가 유지
                this.routes = [
                    {fragment : "#/", component : () => this.home.render(this.target)},
                    {fragment : "#/counter", component : () => this.counter.render(this.target)},
                    {fragment : "#/list", component : () => this.list.render(this.target)}
                ]
            }
            
            render(){
                const findFragment = this.routes.find(route => route.fragment == window.location.hash);
                if (findFragment){
                    findFragment.component(); // target을 내부에서 참조하고 있기 때문에 따로 파라미터로 전달할 필요 없음
                }
            }
            
            setState(){
                this.render();
                window.addEventListener("hashchange", () => this.render());
            }
            
        }

        const router = new Router();
    </script>
</body>
</html>